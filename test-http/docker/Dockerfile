FROM debian:stable

LABEL \
    name="Dockerized Endpoint Testing", \
    maintainer="Colin Payne-Rogers" \
    email="cpaynerogers@mitre.org"

WORKDIR /app

# install python, build prerequisites, MITRE certificates
RUN apt-get update \
    && apt-get install -y \
        ca-certificates \
        curl \
        python3 \
        python3-pip \
        vim \
    && curl -skL 'https://bitbucket.ecis.mitre.org/projects/DOCKER/repos/docker/browse/install/install_mitre_certificates.sh?&raw' | bash \
# prerequisites smoke tests
    && curl --version \
    && pip3 --version \
    && python3 --version

# install required Python packages
# this also points the requests package at the MITRE certificate chain
COPY docker/reqs.txt ./
RUN pip3 install -r reqs.txt \
    && curl -sf http://pki.mitre.org/MITRE-chain.txt -o MITRE-chain.txt \
    && cat MITRE-chain.txt >> "$(python3 -c 'import requests; print(requests.certs.where())')"

COPY src ./src
COPY docker/entrypoint.sh ./
ENTRYPOINT ["/app/entrypoint.sh"]
